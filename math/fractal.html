<html>
 <meta charset="UTF-8"> 
<head>
  <title>Fractal Plotter</title>
     <script src="complex.js"></script> 
	</head>
	<body>
      <h1> Math Pages <a href="./index.html">Index</a></h1>
    <div>
      <p>
        On this page: draw a fractal!
      </p>
    </div>
    <div id="sel" style="float: left;">
      Center x: <input type="number" id="center_x" value="0" step="0.00000001"><br><br>
      Center y: <input type="number" id="center_y" value="0" step="0.00000001"><br><br>
      Zoom: <input type="number" id="zoom" value="0.2" step="0.00000001"><br><br>  
      Max iterations: <input type="text" id="it" value="12" step="1" size=11><br><br>
      Escape Radius: <input type="text" id="esc" value="2" step=".01" size=11><br><br>
      f(x)=<input type="text" id="func" value="add(sqr(x), c)" size=38><br><br>
      <br>
       <input type="button" onclick="graph()" value="Graph"><br><br>
               <div id="loading" style="clear: both; float: bottom">
        </div>
        <br><br>
        
       Defaults:<br><br>
       <input type="button" onclick="set_mandelbrot()" value="Mandelbrot">
       <input type="button" onclick="set_mandelbrot_deep()" value="Deep Mandelbrot">
       <input type="button" onclick="set_zeta()" value="Zeta Fractal">

      </div>
		  <div style="float: right; padding-right: 10%">
      <canvas id="pic" width="800" height="800" style="border:1px solid #000000;"></canvas> 
    </div>
    <div style="float: right; padding-right: 2%">
      <div id="results">
        <br><br>
        <br><br>
        </div>
        <div>
        <a id="download">Download Image</a>
      </div>
    </div>
	</body>
<script>
var pi = 3.14159265358979323846;

//Replaces replaceAll
function replaceAll(str, find, replace) {
  return str.replace(new RegExp(find, 'g'), replace);
}

function set_mandelbrot() {
    document.getElementById("center_x").value = 0;
    document.getElementById("center_y").value = 0;
    document.getElementById("zoom").value = .2;
    document.getElementById("it").value = 12;
    document.getElementById("func").value = "add(sqr(x), c)";
}

function set_mandelbrot_deep() {
    document.getElementById("center_x").value = .2821;
    document.getElementById("center_y").value = .01;
    document.getElementById("zoom").value = 100;
    document.getElementById("it").value = 200;
    document.getElementById("func").value = "add(sqr(x), c)";
}

function set_zeta() {
    document.getElementById("center_x").value = 0;
    document.getElementById("center_y").value = 0;
    document.getElementById("zoom").value = 1;
    document.getElementById("it").value = 12;
    document.getElementById("esc").value = 12;
    document.getElementById("func").value = "add(zeta(x), c)";
}


function graph() {
  document.getElementById("loading").innerHTML = "Please wait...";
  setTimeout(draw,5);
}


function draw() {
  var start = new Date().getTime();
  var pic = document.getElementById("pic").getContext("2d");
  var fx = document.getElementById("func").value;
  var esc_sqr = Number(document.getElementById("esc").value);
  esc_sqr *= esc_sqr;
  var max = Number(document.getElementById("it").value);
  fx = replaceAll(fx, "exp", "pp_tmp");
  fx = replaceAll(fx, "x", "iter");
  fx = replaceAll(fx, "pp_tmp", "exp");
  fx = replaceAll(fx, "c", "pic_z");
  pic.fillStyle = "#000000";
  pic.fillRect(0, 0, 800, 800);
  pic.fillStyle = "#FF0000";
  var center_x = Number(document.getElementById("center_x").value);
  var center_y = Number(document.getElementById("center_y").value);
  var zoom = Number(document.getElementById("zoom").value);
  var pic_z = [center_x - 1 / (2 * zoom), center_y + 1 / (2 * zoom)];
  var add_to_x = 1 / (800 * zoom);
  var add_to_y = 1 / (800 * zoom);
  for (var x = 0; x < 800; ++x) {
    pic_z[1] = center_y + 1 / (2 * zoom);
    for (var y = 0; y < 800; ++y) {
      var iter = pic_z;
      for (var t = 0; t <= max; ++t) {
        iter = eval(fx);
        if (norm_sqr(iter) >= esc_sqr) {
          break;
        }
      }
      if (t >= max - 1) {
          pic.fillRect(x,y,1,1);
      }
      pic_z[1] -= add_to_y;
    }
    pic_z[0] += add_to_x;
  }
  var end = new Date().getTime();
  var time = (end - start) / 1000;
  var pixels = 800 * 800;
  document.getElementById("results").innerHTML = "Time: " + time.toFixed(2) + "<br>";
  document.getElementById("results").innerHTML += "MPx/s: " + (pixels / (1000000 * time)).toFixed(2) + "<br><br><br>";
  document.getElementById("loading").innerHTML = "Done!";
}

function downloadCanvas(link, canvasId, filename) {
    link.href = document.getElementById(canvasId).toDataURL();
    link.download = filename;
}

document.getElementById('download').addEventListener('click', function() {
    downloadCanvas(this, 'pic', 'fractal.png');
}, false);

</script>
</html>