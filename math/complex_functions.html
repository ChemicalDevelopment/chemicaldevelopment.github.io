<html>
 <meta charset="UTF-8"> 
<head>
  <title>Complex Function Plotter</title>
     <script src="https://cdn.rawgit.com/ChemicalDevelopment/libraries.js/master/complex.js"></script> 
     <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
      });
    </script>


    <script type="text/javascript" async
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
	</head>
	<body>
      <h1> Math Pages <a href="./index.html">Index</a></h1>
    <div>
      <p>
        On this page: colorize a complex function
      </p>
    </div>
    <div id="sel" style="float: left;">
      Center x: <input type="text" id="center_x" value="0"><br><br>
      Center y: <input type="text" id="center_y" value="0"><br><br>
      Zoom: <input type="text" id="zoom" value="1 / 10"><br><br>  
      f(z)=<input type="text" id="func" value="z" size=38><br><br>
      <br>
       <input type="button" onclick="graph()" value="Graph">
       <br><br>
        <div id="loading" style="clear: both; float: bottom">
        </div>
        <br><br>
       Defaults:<br><br>
       <input type="button" onclick="set_x()" value="z">
       <input type="button" onclick="set_zeta()" value="Zeta Function">
        <div> 
          <br> Input a complex function, using z as a placeholder
          <br> Set the center for the center of the picture, and the zoom is how zoomed in you are.
          <br> You can think of the 'z' as x + iy for every x and y in the picture
          <br>
        </div>
      </div>
		  <div style="float: right; padding-right: 10%">
      <canvas id="pic" width="800" height="800" style="border:1px solid #000000;" onmousemove="myFunction(event)" onmouseout="clearCoor()"></canvas> 
    </div>
    <div style="float: right; padding-right: 2%">
      <div id="results">
        <br><br>
        <br><br>
        </div>
        Coordinates:<p id="demo"></p>

        <div>
        <a id="download">Download Image</a>
      </div>
    </div>
	</body>

  <script>
function myFunction(e) {
    var x = e.clientX;
    var y = e.clientY;
    var rect = document.getElementById("pic").getBoundingClientRect();
    var coor = get_x_from_pic(x - rect.left).toFixed(4) + " + " + get_y_from_pic(y - rect.top).toFixed(4) + "i";
    document.getElementById("demo").innerHTML = coor;
}

function clearCoor() {
    document.getElementById("demo").innerHTML = "";
}
</script>

<script>
var pi = 3.14159265358979323846;


//Replaces replaceAll
function replaceAll(str, find, replace) {
  return str.replace(new RegExp(find, 'g'), replace);
}

function set_zeta() {
    document.getElementById("center_x").value = 0;
    document.getElementById("center_y").value = 0;
    document.getElementById("zoom").value = "1 / 10";
    document.getElementById("func").value = "zeta(z)";
}

function set_x() {
    document.getElementById("center_x").value = 0;
    document.getElementById("center_y").value = 0;
    document.getElementById("zoom").value = "1 / 10";
    document.getElementById("func").value = "z";
}

function graph() {
  document.getElementById("loading").innerHTML = "Please wait...";
  setTimeout(draw,5);
}


function draw() {
  var start = new Date().getTime();
  var pic = document.getElementById("pic").getContext("2d");
  var fx = document.getElementById("func").value;
  fx = replaceAll(fx, "exp", "pp_tmp");
  fx = replaceAll(fx, "zeta", "ttm");
  fx = replaceAll(fx, "z", "pic_z")
  fx = replaceAll(fx, "pp_tmp", "exp");
  fx = replaceAll(fx, "ttm", "zeta");
  pic.fillStyle = "#000000";
  pic.fillRect(0, 0, 800, 800);
  pic.fillStyle = "#FF0000";
  var center_x = eval(document.getElementById("center_x").value);
  var center_y = eval(document.getElementById("center_y").value);
  var zoom = eval(document.getElementById("zoom").value) / 2;
  var pic_z = [center_x - 1 / (2 * zoom), center_y + 1 / (2 * zoom)];
  var add_to_x = 1 / (800 * zoom);
  var add_to_y = 1 / (800 * zoom);
  for (var x = 0; x < 800; ++x) {
    pic_z[1] = center_y + 1 / (2 * zoom);
    for (var y = 0; y < 800; ++y) {
      pic.fillStyle = (colorize(eval(fx)));
      pic.fillRect(x, y, 1, 1);
      pic_z[1] -= add_to_y;
    }
    pic_z[0] += add_to_x;
  }
  var end = new Date().getTime();
  var time = (end - start) / 1000;
  var pixels = 800 * 800;
  document.getElementById("results").innerHTML = "Time: " + time.toFixed(2) + "<br>";
  document.getElementById("results").innerHTML += "MPx/s: " + (pixels / (1000000 * time)).toFixed(2) + "<br><br><br>";
  document.getElementById("loading").innerHTML = "Done!";
  drawGrid();
}

function drawGrid() {
  var pic = document.getElementById("pic").getContext("2d");
  pic.fillStyle = "#000000";
  pic.fillRect(400, 0, 1, 800);
  pic.fillRect(0, 400, 800, 1);
  pic.font="12px Arial Black";
  pic.strokeStyle = "white";
  pic.lineWidth = 2;
  for (var i = 0; i < 7; ++i) {
    if (i == 3) continue;
    var x = 400;
    var y = i * 800 / 6;

    draw_out(pic, get_y_from_pic(y).toFixed(2) + "i", x + 12, y + 4 );
    draw_out(pic, get_x_from_pic(800 - y).toFixed(2), 800 - (y + 12), 800 - (x + 6));
    pic.fillRect(x - 4, y - 1, 10, 2);
    pic.fillRect(y - 1, x - 4, 2, 10);
  }
  draw_out(pic, get_x_from_pic(400).toFixed(2) + " + " + get_y_from_pic(400).toFixed(2) + "i", 408, 392)
  pic.font="20px Arial Black";
  draw_out(pic, "f(z) = " + document.getElementById("func").value, 10, 25);

}

function draw_out(pic, text, x, y) {
  pic.strokeText(text, x, y);
  pic.fillText(text, x, y);
}

function downloadCanvas(link, canvasId, filename) {
    link.href = document.getElementById(canvasId).toDataURL();
    link.download = filename;
}

//Colorizes a complex number
function colorize(c) {
  //var rad = norm(c);
  var angle = ang(c);
  var o_m = angle; //-pi to +pi
  var _c_r = norm(c);
  var alpha = _c_r * (.8) / (.5);
  if (_c_r >= .5) {
    alpha = .8;
  }
  if (_c_r <= .01) {
    alpha = 0;
  }
  o_m += 2 * pi / 3;
  //var alpha = pi * erf(norm(c) / 15) / 6 + .2;
  var r = Math.floor(255 * (Math.sin(o_m + pi) + 1) / 2);
  var g = Math.floor(255 * (Math.sin(o_m + pi / 3) + 1) / 2);
  var b = Math.floor(255 * (Math.sin(o_m - pi / 3) + 1) / 2);
  return "rgba(" + g + ", " + r + ", " + b + ", " + alpha + ")";
}

function get_x_from_pic(pic_x) {
   var zoom = Number(eval(document.getElementById("zoom").value));
   var center_x = Number(eval(document.getElementById("center_x").value));
   return 2 * ((center_x + 2 * pic_x / (zoom * 800)) / 2 - 1 / (2 * zoom));
}

function get_y_from_pic(pic_y) {
   var zoom = Number(eval(document.getElementById("zoom").value));
   var center_y = Number(eval(document.getElementById("center_y").value));
   var _sc_y = 800 - pic_y
   return 2 * ((center_y + 2 * _sc_y / (zoom * 800)) / 2 - 1 / (2 * zoom));
}


function erf(x) {
  var t = 1 / (1 + .471 * x);
  return 1 - (.348 * t - .096 * t * t + .75 * t * t * t) * Math.exp(- x * x);
}

document.getElementById('download').addEventListener('click', function() {
    downloadCanvas(this, 'pic', 'fractal.png');
}, false);

//window.onload = init_cheb;

</script>
</html>
